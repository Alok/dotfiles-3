#!/bin/bash

if [ -d "$HOME/Dropbox/history" ]; then
    ln -s $HOME/Dropbox/history ~/history
fi
mkdir -p ~/history

dotfiles=$(cd $(dirname $0)/.. && pwd)

# Link dotfiles into ~ and back up the old dotfiles into ~/config-old
find "$dotfiles" -mindepth 1 -maxdepth 1 -not \( \
    -iname '*~' -or \
    -iname '*#*' -or \
    -iname '.hg' -or \
    -iname '.git' -or \
    -iname '.gitmodules' -or \
    -iname 'bin' -or \
    -iname 'misc' -or \
    -iname 'afew' \
    \) | while read file; do
        target=~/"$(basename "$file")"

        # Back up real files (not symlinks) to ~/config-old/
        if [[ -e "$target" && ! -L "$target" ]]
        then
            echo "Moving old version of $target to ~/config-old/$(basename "$file")"
            mkdir -p ~/config-old/
            mv "$target" ~/config-old/
        fi

        # Just delete symlinks, because they are probably from a previous run
        if [[ -L "$target" ]]
        then
            rm "$target"
        fi

        echo "Linking $target"
        ln -s "$file" "$target"
    done

mkdir -p ~/.config/afew
find "$dotfiles"/misc/afew -mindepth 1 -maxdepth 1 | while read file; do
    target=~/.config/afew/"$(basename "$file")"
    if [[ -L "$target" ]]
    then
        rm "$target"
    fi
    echo "Linking $target"
    ln -s "$file" "$target"
done

mkdir -p ~/.sbt/0.13
ln -s "$dotfiles"/misc/ctags.sbt ~/.sbt/0.13/ctags.sbt

# OS X setup
command_exists () {
    type "$1" &> /dev/null ;
}
if [ -d ~/Library ] && command_exists defaults; then
    brew bundle install --global
    pip install -r "$dotfiles"/misc/pip-global-requirements.txt

    # Hard-link ~/Library/KeyBindings/DefaultKeyBinding.dict
    mkdir -p ~/Library/KeyBindings
    target=~/Library/KeyBindings/DefaultKeyBinding.dict
    if [[ -e "$target" ]]
    then
        rm "$target"
    fi

    ln "$dotfiles"/misc/DefaultKeyBinding.dict "$target"

    # Hard-link ~/Library/Preferences/com.googlecode.iterm2.plist
    mkdir -p ~/Library/Preferences
    target=~/Library/Preferences/com.googlecode.iterm2.plist
    if [[ -e "$target" ]]
    then
        rm "$target"
    fi

    ln "$dotfiles"/misc/com.googlecode.iterm2.plist "$target"

    mkdir -p ~/Library/LaunchAgents
    target=~/Library/LaunchAgents/com.ankurdave.sync-mail.plist
    if [[ -e "$target" ]]
    then
        rm "$target"
    fi

    ln "$dotfiles"/misc/com.ankurdave.sync-mail.plist "$target"

    ## From https://github.com/mathiasbynens/dotfiles/blob/master/.macos:
    # Disable the sound effects on boot
    sudo nvram SystemAudioVolume=" "
    # Disable transparency in the menu bar and elsewhere on Yosemite
    defaults write com.apple.universalaccess reduceTransparency -bool true
    # Disable Resume system-wide
    defaults write com.apple.systempreferences NSQuitAlwaysKeepsWindows -bool false
    # Enable full keyboard access for all controls
    # (e.g. enable Tab in modal dialogs)
    defaults write NSGlobalDomain AppleKeyboardUIMode -int 3
    # Faster keyboard repeat rate
    defaults write NSGlobalDomain KeyRepeat -int 2
    defaults write NSGlobalDomain InitialKeyRepeat -int 15
    # Finder: show hidden files by default
    defaults write com.apple.finder AppleShowAllFiles -bool true
    defaults write NSGlobalDomain AppleShowAllExtensions -bool true
    # Disable the warning when changing a file extension
    defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false
    # Use list view in all Finder windows by default
    # Four-letter codes for the other view modes: `icnv`, `clmv`, `Flwv`
    defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv"
    # Speed up Mission Control animations
    defaults write com.apple.dock expose-animation-duration -float 0.1
    # Prevent Photos from opening automatically when devices are plugged in
    defaults -currentHost write com.apple.ImageCapture disableHotPlug -bool true
    # Donâ€™t prompt for confirmation before downloading
    defaults write org.m0k.transmission DownloadAsk -bool false
    defaults write org.m0k.transmission MagnetOpenAsk -bool false
    # IP block list.
    # Source: https://giuliomac.wordpress.com/2014/02/19/best-blocklist-for-transmission/
    defaults write org.m0k.transmission BlocklistNew -bool true
    defaults write org.m0k.transmission BlocklistURL -string "http://john.bitsurge.net/public/biglist.p2p.gz"
    defaults write org.m0k.transmission BlocklistAutoUpdate -bool true

    # Bottom left screen corner puts display to sleep
    defaults write com.apple.dock wvous-bl-corner -int 10
    defaults write com.apple.dock wvous-bl-modifier -int 0

    # Other prefs
    defaults write com.apple.finder CreateDesktop false
    defaults write -app Skim SKAutoReloadFileUpdate -boolean true
fi
