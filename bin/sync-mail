#!/usr/bin/env python

import imaplib2
import netrc
import subprocess
import socket
import time

def imap_password():
    return netrc.netrc().authenticators('imap.gmail.com')[2]

m = None
first_run = True
timeout=5*60
while True:
    try:
        while m is None or m.state == 'LOGOUT':
            try:
                print 'Opening connection'
                m = imaplib2.IMAP4_SSL('imap.gmail.com', timeout=timeout)
            except socket.error as e:
                print 'Error: %s' % (e,)
            if m is None:
                print 'Retrying in 60 seconds'
                time.sleep(60)

        while True:
            if m.state == 'NONAUTH':
                print 'Logging in'
                print m.login('ankurdave@gmail.com', imap_password())
            if m.state != 'SELECTED':
                print 'Selecting mailbox'
                print m.examine('[Gmail]/All Mail')
            if first_run:
                print 'Initial sync'
                first_run = False
            else:
                print 'Waiting for new mail'
                r = m.idle(timeout)
                print 'New mail or timeout: %s' % (r,)
            subprocess.Popen('/Users/ankurdave/repos/dotfiles/bin/sync-mail-once').wait()
            print 'Done syncing'
    except m.abort as e:
        print 'Error: %s' % (e,)
        print 'Retrying in 60 seconds'
        time.sleep(60)
    finally:
        if m:
            try:
                print 'Cleaning up'
                print m.close()
                print m.logout()
                print 'Done.'
            except m.abort as e:
                print 'Error while closing: %s' % (e,)
